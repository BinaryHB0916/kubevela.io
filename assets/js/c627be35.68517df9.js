(window.webpackJsonp=window.webpackJsonp||[]).push([[205],{277:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return s})),t.d(n,"toc",(function(){return c})),t.d(n,"default",(function(){return p}));var a=t(3),r=t(7),i=(t(0),t(332)),o={title:"Crossplane"},s={unversionedId:"platform-engineers/cloud-services",id:"version-v1.0/platform-engineers/cloud-services",isDocsHomePage:!1,title:"Crossplane",description:"Cloud services is also part of your application deployment.",source:"@site/versioned_docs/version-v1.0/platform-engineers/cloud-services.md",slug:"/platform-engineers/cloud-services",permalink:"/docs/platform-engineers/cloud-services",editUrl:"https://github.com/oam-dev/kubevela/edit/master/docs/en/platform-engineers/cloud-services.md",version:"v1.0",lastUpdatedBy:"Jianbo Sun",lastUpdatedAt:1618589155,formattedLastUpdatedAt:"4/16/2021",sidebar:"version-v1.0/docs",previous:{title:"Attach Traits",permalink:"/docs/kube/trait"},next:{title:"How-to",permalink:"/docs/cue/trait"}},c=[{value:"Should a Cloud Service be a Component or Trait?",id:"should-a-cloud-service-be-a-component-or-trait",children:[]},{value:"Install and Configure Crossplane",id:"install-and-configure-crossplane",children:[]},{value:"Register ComponentDefinition and TraitDefinition",id:"register-componentdefinition-and-traitdefinition",children:[{value:"Register ComponentDefinition <code>alibaba-rds</code> as RDS cloud resource producer",id:"register-componentdefinition-alibaba-rds-as-rds-cloud-resource-producer",children:[]},{value:"Register ComponentDefinition <code>alibaba-oss</code> as OSS cloud resource producer",id:"register-componentdefinition-alibaba-oss-as-oss-cloud-resource-producer",children:[]},{value:"Register ComponentDefinition <code>webconsumer</code> with Secret Reference",id:"register-componentdefinition-webconsumer-with-secret-reference",children:[]},{value:"Prepare TraitDefinition <code>service-binding</code> to do env-secret mapping",id:"prepare-traitdefinition-service-binding-to-do-env-secret-mapping",children:[]}]}],l={toc:c};function p(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},l,t,{components:n,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Cloud services is also part of your application deployment."),Object(i.b)("h2",{id:"should-a-cloud-service-be-a-component-or-trait"},"Should a Cloud Service be a Component or Trait?"),Object(i.b)("p",null,"The following practice could be considered:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Use ",Object(i.b)("inlineCode",{parentName:"li"},"ComponentDefinition")," if:",Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},'you want to allow your end users explicitly claim a "instance" of the cloud service and consume it, and release the "instance" when deleting the application.'))),Object(i.b)("li",{parentName:"ul"},"Use ",Object(i.b)("inlineCode",{parentName:"li"},"TraitDefinition")," if:",Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"you don't want to give your end users any control/workflow of claiming or releasing the cloud service, you only want to give them a way to consume a cloud service which could even be managed by some other system. A ",Object(i.b)("inlineCode",{parentName:"li"},"Service Binding")," trait is widely used in this case.")))),Object(i.b)("p",null,"In this documentation, we will define an Alibaba Cloud's RDS (Relational Database Service), and an Alibaba Cloud's OSS (Object Storage System) as example. This mechanism works the same with other cloud providers.\nIn a single application, they are in form of Traits, and in multiple applications, they are in form of Components."),Object(i.b)("h2",{id:"install-and-configure-crossplane"},"Install and Configure Crossplane"),Object(i.b)("p",null,"This guide will use ",Object(i.b)("a",{parentName:"p",href:"https://crossplane.io/"},"Crossplane")," as the cloud service provider. Please Refer to ",Object(i.b)("a",{parentName:"p",href:"https://github.com/crossplane/provider-alibaba/releases/tag/v0.5.0"},"Installation"),"\nto install Crossplane Alibaba provider v0.5.0."),Object(i.b)("p",null,"If you'd like to configure any other Crossplane providers, please refer to ",Object(i.b)("a",{parentName:"p",href:"https://crossplane.io/docs/v1.1/getting-started/install-configure.html#select-a-getting-started-configuration"},"Crossplane Select a Getting Started Configuration"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"$ kubectl crossplane install provider crossplane/provider-alibaba:v0.5.0\n\n# Note the xxx and yyy here is your own AccessKey and SecretKey to the cloud resources.\n$ kubectl create secret generic alibaba-account-creds -n crossplane-system --from-literal=accessKeyId=xxx --from-literal=accessKeySecret=yyy\n\n$ kubectl apply -f provider.yaml\n")),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"provider.yaml")," is as below."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Namespace\nmetadata:\n  name: crossplane-system\n\n---\napiVersion: alibaba.crossplane.io/v1alpha1\nkind: ProviderConfig\nmetadata:\n  name: default\nspec:\n  credentials:\n    source: Secret\n    secretRef:\n      namespace: crossplane-system\n      name: alibaba-account-creds\n      key: credentials\n  region: cn-beijing\n")),Object(i.b)("p",null,"Note: We currently just use Crossplane Alibaba provider. But we are about to use ",Object(i.b)("a",{parentName:"p",href:"https://crossplane.io/"},"Crossplane")," as the\ncloud resource operator for Kubernetes in the near future."),Object(i.b)("h2",{id:"register-componentdefinition-and-traitdefinition"},"Register ComponentDefinition and TraitDefinition"),Object(i.b)("h3",{id:"register-componentdefinition-alibaba-rds-as-rds-cloud-resource-producer"},"Register ComponentDefinition ",Object(i.b)("inlineCode",{parentName:"h3"},"alibaba-rds")," as RDS cloud resource producer"),Object(i.b)("p",null,"Register the ",Object(i.b)("inlineCode",{parentName:"p"},"alibaba-rds")," workload type to KubeVela."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1beta1\nkind: ComponentDefinition\nmetadata:\n  name: alibaba-rds\n  namespace: vela-system\n  annotations:\n    definition.oam.dev/description: "Alibaba Cloud RDS Resource"\nspec:\n  workload:\n    definition:\n      apiVersion: database.alibaba.crossplane.io/v1alpha1\n      kind: RDSInstance\n  schematic:\n    cue:\n      template: |\n        output: {\n            apiVersion: "database.alibaba.crossplane.io/v1alpha1"\n            kind:       "RDSInstance"\n            spec: {\n                forProvider: {\n                    engine:                parameter.engine\n                    engineVersion:         parameter.engineVersion\n                    dbInstanceClass:       parameter.instanceClass\n                    dbInstanceStorageInGB: 20\n                    securityIPList:        "0.0.0.0/0"\n                    masterUsername:        parameter.username\n                }\n                writeConnectionSecretToRef: {\n                    namespace: context.namespace\n                    name:      parameter.secretName\n                }\n                providerConfigRef: {\n                    name: "default"\n                }\n                deletionPolicy: "Delete"\n            }\n        }\n        parameter: {\n            // +usage=RDS engine\n            engine: *"mysql" | string\n            // +usage=The version of RDS engine\n            engineVersion: *"8.0" | string\n            // +usage=The instance class for the RDS\n            instanceClass: *"rds.mysql.c1.large" | string\n            // +usage=RDS username\n            username: string\n            // +usage=Secret name which RDS connection will write to\n            secretName: string\n        }\n\n\n')),Object(i.b)("h3",{id:"register-componentdefinition-alibaba-oss-as-oss-cloud-resource-producer"},"Register ComponentDefinition ",Object(i.b)("inlineCode",{parentName:"h3"},"alibaba-oss")," as OSS cloud resource producer"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1beta1\nkind: ComponentDefinition\nmetadata:\n  name: alibaba-oss\n  namespace: vela-system\n  annotations:\n    definition.oam.dev/description: "Alibaba Cloud RDS Resource"\nspec:\n  workload:\n    definition:\n      apiVersion: oss.alibaba.crossplane.io/v1alpha1\n      kind: Bucket\n  schematic:\n    cue:\n      template: |\n        output: {\n            apiVersion: "oss.alibaba.crossplane.io/v1alpha1"\n            kind:       "Bucket"\n            spec: {\n                name:               parameter.name\n                acl:                parameter.acl\n                storageClass:       parameter.storageClass\n                dataRedundancyType: parameter.dataRedundancyType\n                writeConnectionSecretToRef: {\n                    namespace: context.namespace\n                    name:      parameter.secretName\n                }\n                providerConfigRef: {\n                    name: "default"\n                }\n                deletionPolicy: "Delete"\n            }\n        }\n        parameter: {\n            // +usage=OSS bucket name\n            name: string\n            // +usage=The access control list of the OSS bucket\n            acl: *"private" | string\n            // +usage=The storage type of OSS bucket\n            storageClass: *"Standard" | string\n            // +usage=The data Redundancy type of OSS bucket\n            dataRedundancyType: *"LRS" | string\n            // +usage=Secret name which RDS connection will write to\n            secretName: string\n        }\n\n')),Object(i.b)("h3",{id:"register-componentdefinition-webconsumer-with-secret-reference"},"Register ComponentDefinition ",Object(i.b)("inlineCode",{parentName:"h3"},"webconsumer")," with Secret Reference"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1beta1\nkind: ComponentDefinition\nmetadata:\n  name: webconsumer\n  annotations:\n    definition.oam.dev/description: A Deployment provides declarative updates for Pods and ReplicaSets\nspec:\n  workload:\n    definition:\n      apiVersion: apps/v1\n      kind: Deployment\n  schematic:\n    cue:\n      template: |\n        output: {\n            apiVersion: "apps/v1"\n            kind:       "Deployment"\n            spec: {\n                selector: matchLabels: {\n                    "app.oam.dev/component": context.name\n                }\n\n                template: {\n                    metadata: labels: {\n                        "app.oam.dev/component": context.name\n                    }\n\n                    spec: {\n                        containers: [{\n                            name:  context.name\n                            image: parameter.image\n\n                            if parameter["cmd"] != _|_ {\n                                command: parameter.cmd\n                            }\n\n                            if parameter["dbSecret"] != _|_ {\n                                env: [\n                                    {\n                                        name:  "username"\n                                        value: dbConn.username\n                                    },\n                                    {\n                                        name:  "endpoint"\n                                        value: dbConn.endpoint\n                                    },\n                                    {\n                                        name:  "DB_PASSWORD"\n                                        value: dbConn.password\n                                    },\n                                ]\n                            }\n\n                            ports: [{\n                                containerPort: parameter.port\n                            }]\n\n                            if parameter["cpu"] != _|_ {\n                                resources: {\n                                    limits:\n                                        cpu: parameter.cpu\n                                    requests:\n                                        cpu: parameter.cpu\n                                }\n                            }\n                        }]\n                }\n                }\n            }\n        }\n\n        parameter: {\n            // +usage=Which image would you like to use for your service\n            // +short=i\n            image: string\n\n            // +usage=Commands to run in the container\n            cmd?: [...string]\n\n            // +usage=Which port do you want customer traffic sent to\n            // +short=p\n            port: *80 | int\n\n            // +usage=Referred db secret\n            // +insertSecretTo=dbConn\n            dbSecret?: string\n\n            // +usage=Number of CPU units for the service, like `0.5` (0.5 CPU core), `1` (1 CPU core)\n            cpu?: string\n        }\n\n        dbConn: {\n            username: string\n            endpoint: string\n            password: string\n        }\n\n')),Object(i.b)("p",null,"The key point is the annotation ",Object(i.b)("inlineCode",{parentName:"p"},"//+insertSecretTo=dbConn"),", KubeVela will know the parameter is a K8s secret, it will parse\nthe secret and bind the data into the CUE struct ",Object(i.b)("inlineCode",{parentName:"p"},"dbConn"),"."),Object(i.b)("p",null,"Then the ",Object(i.b)("inlineCode",{parentName:"p"},"output")," can reference the ",Object(i.b)("inlineCode",{parentName:"p"},"dbConn")," struct for the data value. The name ",Object(i.b)("inlineCode",{parentName:"p"},"dbConn")," can be any name.\nIt's just an example in this case. The ",Object(i.b)("inlineCode",{parentName:"p"},"+insertSecretTo")," is keyword, it defines the data binding mechanism."),Object(i.b)("h3",{id:"prepare-traitdefinition-service-binding-to-do-env-secret-mapping"},"Prepare TraitDefinition ",Object(i.b)("inlineCode",{parentName:"h3"},"service-binding")," to do env-secret mapping"),Object(i.b)("p",null,"As for data binding in Application, KubeVela recommends defining a trait to finish the job. We have prepared a common\ntrait for convenience. This trait works well for binding resources' info into pod spec Env."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1beta1\nkind: TraitDefinition\nmetadata:\n  annotations:\n    definition.oam.dev/description: "binding cloud resource secrets to pod env"\n  name: service-binding\nspec:\n  appliesToWorkloads:\n    - webservice\n    - worker\n  schematic:\n    cue:\n      template: |\n        patch: {\n            spec: template: spec: {\n                // +patchKey=name\n                containers: [{\n                    name: context.name\n                    // +patchKey=name\n                    env: [\n                        for envName, v in parameter.envMappings {\n                            name: envName\n                            valueFrom: {\n                                secretKeyRef: {\n                                    name: v.secret\n                                    if v["key"] != _|_ {\n                                        key: v.key\n                                    }\n                                    if v["key"] == _|_ {\n                                        key: envName\n                                    }\n                                }\n                            }\n                        },\n                    ]\n                }]\n            }\n        }\n\n        parameter: {\n            // +usage=The mapping of environment variables to secret\n            envMappings: [string]: [string]: string\n        }\n\n')),Object(i.b)("p",null,"With the help of this ",Object(i.b)("inlineCode",{parentName:"p"},"service-binding")," trait, developers can explicitly set parameter ",Object(i.b)("inlineCode",{parentName:"p"},"envMappings")," to mapping all\nenvironment names with secret key. Here is an example."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"...\n      traits:\n        - type: service-binding\n          properties:\n            envMappings:\n              # environments refer to db-conn secret\n              DB_PASSWORD:\n                secret: db-conn\n                key: password                                     # 1) If the env name is different from secret key, secret key has to be set.\n              endpoint:\n                secret: db-conn                                   # 2) If the env name is the same as the secret key, secret key can be omitted.\n              username:\n                secret: db-conn\n              # environments refer to oss-conn secret\n              BUCKET_NAME:\n                secret: oss-conn\n                key: Bucket\n...\n")),Object(i.b)("p",null,"You can see ",Object(i.b)("a",{parentName:"p",href:"../end-user/cloud-resources"},"the end user usage workflow")," to know how it used. "))}p.isMDXComponent=!0},332:function(e,n,t){"use strict";t.d(n,"a",(function(){return d})),t.d(n,"b",(function(){return b}));var a=t(0),r=t.n(a);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=r.a.createContext({}),p=function(e){var n=r.a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},d=function(e){var n=p(e.components);return r.a.createElement(l.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},u=r.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=p(t),u=a,b=d["".concat(o,".").concat(u)]||d[u]||m[u]||i;return t?r.a.createElement(b,s(s({ref:n},l),{},{components:t})):r.a.createElement(b,s({ref:n},l))}));function b(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=u;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var l=2;l<i;l++)o[l]=t[l];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,t)}u.displayName="MDXCreateElement"}}]);