(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{107:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return i})),t.d(n,"metadata",(function(){return c})),t.d(n,"toc",(function(){return l})),t.d(n,"default",(function(){return p}));var a=t(3),o=t(7),r=(t(0),t(199)),i={title:"Defining Cloud Database as Component"},c={unversionedId:"platform-engineers/cloud-services",id:"platform-engineers/cloud-services",isDocsHomePage:!1,title:"Defining Cloud Database as Component",description:"KubeVela provides unified abstraction even for cloud services.",source:"@site/docs/platform-engineers/cloud-services.md",slug:"/platform-engineers/cloud-services",permalink:"/zh/docs/platform-engineers/cloud-services",editUrl:"https://github.com/oam-dev/kubevela.io/edit/main/docs/platform-engineers/cloud-services.md",version:"current",lastUpdatedBy:"yangsoon",lastUpdatedAt:1616906659,formattedLastUpdatedAt:"3/28/2021"},l=[{value:"Should a Cloud Service be a Component or Trait?",id:"should-a-cloud-service-be-a-component-or-trait",children:[]},{value:"Step 1: Install and Configure Crossplane",id:"step-1-install-and-configure-crossplane",children:[]},{value:"Step 2: Add Component Definition",id:"step-2-add-component-definition",children:[]},{value:"Step 3: Verify",id:"step-3-verify",children:[]},{value:"Step 4: Consuming The Cloud Service",id:"step-4-consuming-the-cloud-service",children:[{value:"<code>ComponentDefinition</code> With Secret Reference",id:"componentdefinition-with-secret-reference",children:[]}]}],s={toc:l};function p(e){var n=e.components,t=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},s,t,{components:n,mdxType:"MDXLayout"}),Object(r.b)("p",null,"KubeVela provides unified abstraction even for cloud services."),Object(r.b)("h2",{id:"should-a-cloud-service-be-a-component-or-trait"},"Should a Cloud Service be a Component or Trait?"),Object(r.b)("p",null,"The following practice could be considered:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Use ",Object(r.b)("inlineCode",{parentName:"li"},"ComponentDefinition")," if:",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},'you want to allow your end users explicitly claim a "instance" of the cloud service and consume it, and release the "instance" when deleting the application.'))),Object(r.b)("li",{parentName:"ul"},"Use ",Object(r.b)("inlineCode",{parentName:"li"},"TraitDefinition")," if:",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"you don't want to give your end users any control/workflow of claiming or releasing the cloud service, you only want to give them a way to consume a cloud service which could even be managed by some other system. A ",Object(r.b)("inlineCode",{parentName:"li"},"Service Binding")," trait is widely used in this case.")))),Object(r.b)("p",null,"In this documentation, we will add a Alibaba Cloud's RDS (Relational Database Service) as a component."),Object(r.b)("h2",{id:"step-1-install-and-configure-crossplane"},"Step 1: Install and Configure Crossplane"),Object(r.b)("p",null,"KubeVela uses ",Object(r.b)("a",{parentName:"p",href:"https://crossplane.io/"},"Crossplane")," as the cloud service operator."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"This tutorial has been tested with Crossplane version ",Object(r.b)("inlineCode",{parentName:"p"},"0.14"),". Please follow the ",Object(r.b)("a",{parentName:"p",href:"https://crossplane.io/docs/"},"Crossplane documentation"),", especially the ",Object(r.b)("inlineCode",{parentName:"p"},"Install & Configure")," and ",Object(r.b)("inlineCode",{parentName:"p"},"Compose Infrastructure")," sections to configure\nCrossplane with your cloud account.")),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Note: When installing Crossplane via Helm chart, please DON'T set ",Object(r.b)("inlineCode",{parentName:"strong"},"alpha.oam.enabled=true")," as all OAM features are already installed by KubeVela.")),Object(r.b)("h2",{id:"step-2-add-component-definition"},"Step 2: Add Component Definition"),Object(r.b)("p",null,"Register the ",Object(r.b)("inlineCode",{parentName:"p"},"rds")," component to KubeVela."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'$ cat << EOF | kubectl apply -f -\napiVersion: core.oam.dev/v1beta1\nkind: ComponentDefinition\nmetadata:\n  name: rds\n  annotations:\n    definition.oam.dev/apiVersion: "database.example.org/v1alpha1"\n    definition.oam.dev/kind: "PostgreSQLInstance"\n    definition.oam.dev/description: "RDS on Ali Cloud"\nspec:\n  workload:\n    definition:\n      apiVersion: database.example.org/v1alpha1\n      kind: PostgreSQLInstance\n  schematic:\n    cue:\n      template: |\n        output: {\n            apiVersion: "database.example.org/v1alpha1"\n            kind:       "PostgreSQLInstance"\n            metadata:\n                name: context.name\n            spec: {\n                parameters:\n                    storageGB: parameter.storage\n                compositionSelector: {\n                    matchLabels:\n                        provider: parameter.provider\n                }\n                writeConnectionSecretToRef:\n                    name: parameter.secretname\n            }\n        }\n\n        parameter: {\n            secretname: *"db-conn" | string\n            provider:   *"alibaba" | string\n            storage:    *20 | int\n        }\nEOF\n')),Object(r.b)("h2",{id:"step-3-verify"},"Step 3: Verify"),Object(r.b)("p",null,"Instantiate RDS component in an ",Object(r.b)("a",{parentName:"p",href:"../application"},"Application")," to provide cloud resources."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1beta1\nkind: Application\nmetadata:\n  name: mydatabase\nspec:\n  components:\n    - name: myrds\n      type: rds\n      properties:\n        name: "alibaba-rds"\n        storage: 20\n        secretname: "myrds-conn"\n')),Object(r.b)("p",null,"Apply above application to Kubernetes and a RDS instance will be automatically provisioned (may take some time, ~5 mins)."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"TBD: add status check , show database create result.")),Object(r.b)("h2",{id:"step-4-consuming-the-cloud-service"},"Step 4: Consuming The Cloud Service"),Object(r.b)("p",null,"In this section, we will show how another component consumes the RDS instance."),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},"Note: we recommend to define the cloud resource claiming to an independent application if that cloud resource has standalone lifecycle. Otherwise, it could be defined in the same application of the consumer component.")),Object(r.b)("h3",{id:"componentdefinition-with-secret-reference"},Object(r.b)("inlineCode",{parentName:"h3"},"ComponentDefinition")," With Secret Reference"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1beta1\nkind: ComponentDefinition\nmetadata:\n  name: webserver\n  annotations:\n    definition.oam.dev/description: "webserver to consume cloud resources"\nspec:\n  workload:\n    definition:\n      apiVersion: apps/v1\n      kind: Deployment\n  schematic:\n    cue:\n      template: |\n        output: {\n            apiVersion: "apps/v1"\n            kind:       "Deployment"\n            spec: {\n                selector: matchLabels: {\n                    "app.oam.dev/component": context.name\n                }\n                template: {\n                    metadata: labels: {\n                        "app.oam.dev/component": context.name\n                    }\n                    spec: {\n                        containers: [{\n                            name:  context.name\n                            image: parameter.image\n\n                            if parameter["cmd"] != _|_ {\n                                command: parameter.cmd\n                            }\n                            env: [{\n                                name:  "DB_NAME"\n                                value: mySecret.dbName\n                            }, {\n                                name:  "DB_PASSWORD"\n                                value: mySecret.password\n                            }]\n                        }]\n                    }\n                }\n            }\n        }\n        mySecret: {\n            dbName:   string\n            password: string\n        }\n        parameter: {\n            image: string\n            //+InsertSecretTo=mySecret\n            dbConnection: string\n            cmd?: [...string]\n        }       \n')),Object(r.b)("p",null,"With the ",Object(r.b)("inlineCode",{parentName:"p"},"//+InsertSecretTo=mySecret")," annotation, KubeVela knows this parameter value comes from a Kubernetes Secret (whose name is set by user), so it will inject its data to ",Object(r.b)("inlineCode",{parentName:"p"},"mySecret")," which is referenced as environment variable in the template."),Object(r.b)("p",null,"Then declare an application to consume the RDS instance."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: core.oam.dev/v1alpha2\nkind: Application\nmetadata:\n  name: data-consumer\nspec:\n  components:\n    - name: myweb\n      type: webserver\n      properties:\n        image: "nginx"\n        dbConnection: "mydb-outputs"\n')),Object(r.b)("p",null,"// TBD show the result"))}p.isMDXComponent=!0},199:function(e,n,t){"use strict";t.d(n,"a",(function(){return d})),t.d(n,"b",(function(){return b}));var a=t(0),o=t.n(a);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=o.a.createContext({}),p=function(e){var n=o.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):c(c({},n),e)),t},d=function(e){var n=p(e.components);return o.a.createElement(s.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return o.a.createElement(o.a.Fragment,{},n)}},u=o.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),d=p(t),u=a,b=d["".concat(i,".").concat(u)]||d[u]||m[u]||r;return t?o.a.createElement(b,c(c({ref:n},s),{},{components:t})):o.a.createElement(b,c({ref:n},s))}));function b(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,i=new Array(r);i[0]=u;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var s=2;s<r;s++)i[s]=t[s];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,t)}u.displayName="MDXCreateElement"}}]);